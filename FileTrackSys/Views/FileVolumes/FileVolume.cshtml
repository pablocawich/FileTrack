@model FileTracking.ViewModels.VolumesViewModel
@{
    ViewBag.Title = "FileVolume";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">
    <div class="col-lg-12">
        <h2 class="page-header"><strong>File Volume</strong></h2>
    </div>
    <!-- /.col-lg-12 -->
</div>

<div class="row">
    <p style="color: chocolate"><i>Volumes listed here are for the file record below:</i></p>
    <div class="col-lg-4">
        <ul class="list-group">
            <li class="list-group-item">
                <span class="badge"><i class="fa fa-list-alt"></i></span>
                <strong>File Number:</strong> @Model.File.FileNumber
            </li>
            <li class="list-group-item">
                <span class="badge"><i class="fa fa-user"></i></span>
                <strong> Client:</strong> @Model.File.FirstName @Model.File.MiddleName @Model.File.LastName
            </li>
            <li class="list-group-item">
                <span class="badge"><i class="fa fa-volume-up"></i></span>
                <strong>Volumes: </strong>@Model.File.Volume
            </li>
        </ul>
    </div>
    <table id="volumeTable" class="table  table-bordered table-hover">
        <thead>
            <tr class="row100 head">
                <th>Volume</th>
                <th><i class="glyphicon glyphicon-comment"></i> Comment</th>
                <th><i class="fa fa-ellipsis-h"></i> State</th>
                <th><i class="glyphicon glyphicon-home"></i> Location Origin</th>
                <th><i class="glyphicon glyphicon-map-marker"></i> Current location</th>
                <th><i class="glyphicon glyphicon-user"></i> Holding user</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var fileVol in Model.FileVolumes)
            {
                <tr>
                    <td>@fileVol.Volume</td>
                    @if (fileVol.Comment == null)
                    {
                        <td>Empty</td>
                    }
                    else
                    {
                        <td>@fileVol.Comment</td>
                    }
                    <td class="tdState">@fileVol.States.State</td>
                    <td>@fileVol.Branches.Branch</td>
                    <td class="currentLoc" currLoc-data="@fileVol.CurrentLocation"></td>
                    @if (@fileVol.AdUserId == null)
                    {
                        <td>At registry</td>
                    }
                    else
                    {
                        <td>@fileVol.AdUser.Username</td>
                    }

                    <td class="tdBtn">
                        <button type="button" vol-state="@fileVol.States.State" user-loc="@Model.AdUser.BranchesId" originLoc="@fileVol.BranchesId" currLoc-attr="@fileVol.CurrentLocation"
                                vol-data-id="@fileVol.Id" file-name="@Model.File.FirstName" location="@fileVol.Branches.Branch" class="btn btn-dropbox js-req-vol">
                            <i class="glyphicon glyphicon-new-window"></i>
                        </button>

                    </td>

                </tr>
            }
        </tbody>
    </table>
</div>
@section scripts
{
    <script>
        $(document).ready(function() {

            $("#volumeTable").on("click",
                ".js-req-vol",
                function() {
                    var button = $(this);
                    var loc = button.attr('location');
                    var state = button.attr("vol-state");
                    var originalLoc = button.attr("originLoc");
                    var currentLoc = button.attr("currLoc-attr");
                    var userLoc = button.attr("user-loc");
                    //------------------------------the above retrieves attributes necessary for routing ----------
                    if (state === "Checked Out" || state === "Transfer") {
                        toastr.error(
                            "Volume CANNOT be requested. Currently being transferred or has already been checked-out",
                            "Volume Request",
                            { positionClass: "toast-bottom-right" });
                        $(this).prop("disabled", true);
                    } else {
                        if (!(userLoc == currentLoc)) {
                            bootbox.confirm({
                                message:
                                    "<strong style='color: #ff7144'>This volume is outside your branch. Your request will be sent to <strong>" + loc + "</strong>. Continue?</strong>",
                                buttons: {
                                    confirm: {
                                        label: 'Yes',
                                        className: 'btn-success'
                                    },
                                    cancel: {
                                        label: 'Never mind',
                                        className: 'btn-github'
                                    }
                                },
                                callback: function (result) {
                                    if (result) {
                                        //write code tht routes volumes id to an action result in volumes controller.
                                        window.location.href =
                                            "/Requests/Index/" + button.attr("vol-data-id");
                                    }
                                }
                            });

                        } else {
                            if (originalLoc == currentLoc)
                                if (state === "Stored" || state === "Requested") {
                                    bootbox.confirm({
                                        message:
                                            "Volume within the vicinity thus if you proceed your request will be sent to your registry and you must await approval",
                                        buttons: {
                                            confirm: {
                                                label: 'Proceed',
                                                className: 'btn-success'
                                            },
                                            cancel: {
                                                label: 'Never mind',
                                                className: 'btn-github'
                                            }
                                        },
                                        callback: function (result) {
                                            if (result) {
                                                //write code tht routes volumes id to an action result in volumes controller
                                                // window.location.href = "/FileVolumes/RequestFile/" + button.attr("data-request-file-id");
                                                window.location.href =
                                                    "/Requests/Index/" + button.attr("vol-data-id");
                                            }
                                        }
                                    });
                                } 
                        }
                    }
                    


                });
            //inserting a string value for current location
            $(".currentLoc").each(function() {
                var locNum = $(this).attr("currLoc-data");
                var num = parseInt(locNum);
                switch (num) {
                case 1:
                    $(this).text("Corozal");
                    break;
                case 2:
                    $(this).text("Orange Walk");
                    break;
                case 3:
                    $(this).text("Belize City");
                    break;
                case 4:
                    $(this).text("San Pedro");
                    break;
                case 5:
                    $(this).text("Belmopan");
                    break;
                case 6:
                    $(this).text("Dangriga");
                    break;
                }
            });

        });

    </script>
}
